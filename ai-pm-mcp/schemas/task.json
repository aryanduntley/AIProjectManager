{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "task.json",
  "title": "Task File Schema",
  "description": "Schema for task files in Tasks/active/",
  "type": "object",
  "properties": {
    "taskId": {
      "type": "string",
      "pattern": "^TASK-\\d{4}-\\d{2}-\\d{2}-\\d{6}$",
      "description": "Unique task identifier with timestamp format TASK-YYYY-MM-DD-HHMMSS"
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Brief descriptive title of the task"
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "Detailed description of what needs to be accomplished"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "in-progress", "blocked", "completed", "cancelled"],
      "default": "pending",
      "description": "Current status of the task"
    },
    "priority": {
      "type": "string",
      "enum": ["low", "medium", "high", "urgent"],
      "default": "medium",
      "description": "Task priority level"
    },
    "milestone": {
      "type": "object",
      "properties": {
        "milestoneId": {
          "type": "string",
          "pattern": "^M\\d{2}$",
          "description": "Reference to milestone in completion-path.json"
        },
        "milestone": {
          "type": "string",
          "description": "Milestone title for reference"
        }
      },
      "required": ["milestoneId", "milestone"],
      "additionalProperties": false
    },
    "theme": {
      "type": "object",
      "properties": {
        "primaryTheme": {
          "type": "string",
          "minLength": 1,
          "description": "Primary theme this task belongs to"
        },
        "relatedThemes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true,
          "description": "Additional themes related to this task"
        }
      },
      "required": ["primaryTheme"],
      "additionalProperties": false
    },
    "contextMode": {
      "type": "string",
      "enum": ["theme-focused", "theme-expanded", "project-wide"],
      "default": "theme-focused",
      "description": "Context loading mode for this task"
    },
    "estimatedEffort": {
      "type": "string",
      "pattern": "^(\\d+(\\.\\d+)?)(h|d|w)$",
      "description": "Estimated effort (e.g., '2h', '1.5d', '1w')"
    },
    "actualEffort": {
      "type": "string",
      "pattern": "^(\\d+(\\.\\d+)?)(h|d|w)$",
      "description": "Actual effort spent (e.g., '2h', '1.5d', '1w')"
    },
    "acceptanceCriteria": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "description": "List of criteria that must be met for task completion"
    },
    "subtasks": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "subtaskId": {
            "type": "string",
            "pattern": "^ST\\d{3}$",
            "description": "Unique subtask identifier"
          },
          "title": {
            "type": "string",
            "minLength": 1,
            "description": "Subtask title"
          },
          "description": {
            "type": "string",
            "description": "Detailed subtask description"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in-progress", "blocked", "completed"],
            "default": "pending",
            "description": "Subtask status"
          },
          "multiFlow": {
            "type": "object",
            "properties": {
              "flowReferences": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "flowId": {
                      "type": "string",
                      "description": "Flow identifier"
                    },
                    "flowFile": {
                      "type": "string",
                      "pattern": ".*-flow\\.json$",
                      "description": "Flow file name (e.g., authentication-flow.json)"
                    },
                    "steps": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Specific flow steps this subtask implements"
                    }
                  },
                  "required": ["flowId", "flowFile"],
                  "additionalProperties": false
                },
                "description": "Flow references with file context"
              }
            },
            "required": ["flowReferences"],
            "additionalProperties": false
          },
          "files": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Files related to this subtask"
          },
          "dependencies": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Dependencies on other subtasks or external factors"
          },
          "blockers": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "description": {
                  "type": "string",
                  "description": "Description of the blocker"
                },
                "type": {
                  "type": "string",
                  "enum": ["technical", "resource", "dependency", "approval"],
                  "description": "Type of blocker"
                },
                "resolution": {
                  "type": "string",
                  "description": "How to resolve this blocker"
                }
              },
              "required": ["description", "type"],
              "additionalProperties": false
            },
            "description": "Current blockers preventing progress"
          },
          "completedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when subtask was completed"
          },
          "notes": {
            "type": "string",
            "description": "Additional notes or observations"
          }
        },
        "required": ["subtaskId", "title", "description", "multiFlow"],
        "additionalProperties": false
      },
      "description": "List of subtasks with multi-flow integration"
    },
    "sidequests": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "sidequestId": {
            "type": "string",
            "pattern": "^SQ-\\d{4}-\\d{2}-\\d{2}-\\d{6}-\\d{3}$",
            "description": "Sidequest identifier with sequence number"
          },
          "parentSubtask": {
            "type": "string",
            "pattern": "^ST\\d{3}$",
            "description": "Subtask that spawned this sidequest"
          },
          "title": {
            "type": "string",
            "minLength": 1,
            "description": "Sidequest title"
          },
          "reason": {
            "type": "string",
            "description": "Why this sidequest was created"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in-progress", "completed", "cancelled"],
            "default": "pending",
            "description": "Sidequest status"
          }
        },
        "required": ["sidequestId", "parentSubtask", "title", "reason"],
        "additionalProperties": false
      },
      "description": "References to sidequest files spawned from this task"
    },
    "progressPercentage": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "default": 0,
      "description": "Overall task completion percentage"
    },
    "reviewRequired": {
      "type": "boolean",
      "default": false,
      "description": "Whether this task requires user review before completion"
    },
    "assignedTo": {
      "type": "string",
      "default": "ai-agent",
      "description": "Who is responsible for completing this task"
    },
    "testingRequirements": {
      "type": "object",
      "properties": {
        "testTypes": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["unit", "integration", "e2e", "manual", "performance"]
          },
          "description": "Types of testing required"
        },
        "testCoverage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Required test coverage percentage"
        },
        "testFiles": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Test files to be created or updated"
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "properties": {
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Task creation timestamp"
        },
        "lastUpdated": {
          "type": "string",
          "format": "date-time",
          "description": "Last modification timestamp"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Task completion timestamp"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "default": "1.0.0",
          "description": "Task file version"
        },
        "sessionId": {
          "type": "string",
          "description": "Session ID when task was created"
        }
      },
      "required": ["createdAt", "lastUpdated", "version"],
      "additionalProperties": false
    }
  },
  "required": ["taskId", "title", "description", "milestone", "theme", "subtasks", "metadata"],
  "additionalProperties": false
}